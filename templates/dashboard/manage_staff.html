{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Gestionar Personal - Tivy{% endblock %}

{% block page_title %}Gestionar Personal{% endblock %}

{% block breadcrumb %}
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="active">Gestionar Personal</li>
{% endblock %}


{% block content %}

{# --- INICIO: CSS PARA TABLA RESPONSIVE EN MÓVIL --- #}
<style>
@media (max-width: 767px) {
    /* Ocultamos los encabezados (headers) originales */
    .table-responsive-cards thead {
        display: none;
    }

    /* La fila (tr) se comporta como una tarjeta */
    .table-responsive-cards tbody tr {
        display: block;
        width: 100%;
        margin-bottom: 1.5rem; /* Aumentado para más espacio */
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* La celda (td) se apila verticalmente */
    .table-responsive-cards tbody td {
        display: block;
        width: 100%;
        text-align: right; /* Alinea el dato a la derecha */
        padding-left: 50%; /* Deja espacio para el label */
        padding-top: 12px;
        padding-bottom: 12px;
        position: relative;
        border-bottom: 1px solid #eee;
    }
    
    .table-responsive-cards tbody td:last-child {
        border-bottom: none; /* Sin borde en la última celda */
    }

    /* Creamos el "label" (Nombre, Tipo, etc.) usando el atributo data-label */
    .table-responsive-cards tbody td::before {
        content: attr(data-label); /* Esta es la magia */
        position: absolute;
        left: 15px; /* Más padding */
        top: 50%;
        transform: translateY(-50%);
        width: 45%;
        text-align: left;
        font-weight: bold;
        color: #333;
    }
    
    /* Ajuste para el botón de "Acciones" */
    .table-responsive-cards tbody td[data-label="Acciones"] {
        text-align: center;
        padding-left: 15px; /* Reset padding */
    }
    .table-responsive-cards tbody td[data-label="Acciones"]::before {
        display: none; /* No queremos un label "Acciones:" */
    }
}
</style>
{# --- FIN: CSS PARA TABLA RESPONSIVE EN MÓVIL --- #}


    {% if messages %}
        {% for message in messages %}
             <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'info' %}alert-info{% else %}alert-danger{% endif %} alert-dismissible">
                <button class="close" data-dismiss="alert"><i class="pci-cross pci-circle"></i></button>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="panel">
        <div class="panel-heading">
            <h3 class="panel-title">Personal / Recursos Actuales ({{ current_staff_count }}/{{ max_staff }})</h3>
        </div>
        <div class="panel-body">
            {% if staff_list %}
            
                {# --- MODIFICACIÓN 1: Se añadió la clase 'table-responsive-cards' --- #}
                <div class="table-responsive table-responsive-cards">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for staff in staff_list %}
                            <tr>
                                {# --- MODIFICACIÓN 2: Se añadieron los atributos 'data-label' --- #}
                                <td data-label="Nombre">{{ staff.name }}</td>
                                <td data-label="Tipo">
                                    {% if staff.user %}
                                        <span class="badge badge-info">Usuario con Acceso</span>
                                    {% else %}
                                        <span class="badge badge-default">Recurso</span>
                                    {% endif %}
                                </td>
                                <td data-label="Estado">
                                    {% if staff.is_active %}
                                        <span class="badge badge-success">Activo</span>
                                    {% else %}
                                        <span class="badge badge-danger">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td data-label="Acciones">
                                    {% if staff.user == request.user %}
        
                                    <button class="btn btn-xs btn-default" 
                                            disabled="disabled" 
                                            title="Para editar tus datos personales, ve a 'Configuración Negocio' o 'Mi Perfil'.">
                                        Editar (Tú)
                                    </button>
                                    
                                {% else %}
                                
                                    <a href="{% url 'edit_staff' pk=staff.pk %}" class="btn btn-xs btn-default">
                                        Editar
                                    </a>
                                    
                                {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aún no has añadido personal o recursos.</p>
            {% endif %}
        </div>
    </div>

    {# --- Formulario para Añadir Nuevo --- #}
    {% if can_add_staff %}
        <div class="panel">
            <div class="panel-heading">
                <h3 class="panel-title">Añadir Nuevo Personal o Recurso</h3>
            </div>
            <div class="panel-body">
                <form method="post" id="add-staff-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                         <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                         {{ form.name|add_class:"form-control" }}
                         {% include 'includes/field_errors.html' with field=form.name %}
                    </div>

                    <div class="form-check mb-3">
                        {# Usamos el ID explícito que le dimos al widget #}
                        {{ form.give_access|add_class:"form-check-input"|attr:"id:id_give_access" }} 
                        <label class="form-check-label" for="id_give_access">
                            {{ form.give_access.label }}
                        </label>
                         {% include 'includes/field_errors.html' with field=form.give_access %}
                    </div>
                    
                    {# --- Campos Condicionales Actualizados --- #}
                    <div id="access-fields" style="display: {% if form.give_access.value %}block{% else %}none{% endif %};">
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                            {{ form.email|add_class:"form-control" }}
                            <small class="form-text text-muted">Si el usuario ya existe, se vinculará. Si no, se creará una cuenta.</small>
                            {% include 'includes/field_errors.html' with field=form.email %}
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }}</label>
                                {{ form.first_name|add_class:"form-control" }}
                                {% include 'includes/field_errors.html' with field=form.first_name %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                                {{ form.last_name|add_class:"form-control" }}
                                {% include 'includes/field_errors.html' with field=form.last_name %}
                            </div>
                        </div>
                         <div class="mb-3">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">{{ form.phone_number.label }}</label>
                            {{ form.phone_number|add_class:"form-control" }}
                            {% include 'includes/field_errors.html' with field=form.phone_number %}
                        </div>
                    </div>
                     {# --- Fin Campos Condicionales --- #}

                    <button type="submit" class="btn btn-primary">Añadir</button>
                </form>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning">
            {{ limit_message }} <a href="#">Actualiza tu plan</a> para añadir más personal.
        </div>
    {% endif %}

{% endblock %}

{% block page_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const giveAccessCheckbox = document.getElementById('id_give_access'); // Usamos el ID que pusimos
    const accessFieldsDiv = document.getElementById('access-fields');
    // Seleccionamos todos los inputs dentro del div condicional
    const accessInputs = accessFieldsDiv ? accessFieldsDiv.querySelectorAll('input') : []; 

    function toggleAccessFields() {
        if (!giveAccessCheckbox || !accessFieldsDiv) return;
        
        const isChecked = giveAccessCheckbox.checked;
        accessFieldsDiv.style.display = isChecked ? 'block' : 'none';
        
        // Hacemos que los campos dentro sean requeridos solo si el checkbox está marcado
        accessInputs.forEach(input => {
            // Asumimos que todos excepto el teléfono son requeridos si se da acceso
            if (input.name !== 'phone_number'){
                 input.required = isChecked;
            } else {
                 input.required = false; // Teléfono sigue siendo opcional
            }
        });
    }

    if(giveAccessCheckbox){
        toggleAccessFields(); // Ejecutar al cargar
        giveAccessCheckbox.addEventListener('change', toggleAccessFields); // Ejecutar al cambiar
    }
});
</script>
{% endblock %}