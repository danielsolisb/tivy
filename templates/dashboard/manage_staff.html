{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Gestionar Personal - Tivy{% endblock %}

{% block page_title %}Gestionar Personal{% endblock %}

{% block breadcrumb %}
    <li><a href="{% url 'dashboard' %}\">Dashboard</a></li>
    <li class="active">Gestionar Personal</li>
{% endblock %}


{% block content %}

{# --- CSS PARA TABLA RESPONSIVE (Sin Cambios) --- #}
<style>
@media (max-width: 767px) {
    .table-responsive-cards thead { display: none; }
    .table-responsive-cards tbody tr { display: block; width: 100%; margin-bottom: 1.5rem; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .table-responsive-cards tbody td { display: block; width: 100%; text-align: right; padding-left: 50%; padding-top: 12px; padding-bottom: 12px; position: relative; border-bottom: 1px solid #eee; }
    .table-responsive-cards tbody td:last-child { border-bottom: none; }
    .table-responsive-cards tbody td::before { content: attr(data-label); position: absolute; left: 15px; top: 50%; transform: translateY(-50%); width: 45%; text-align: left; font-weight: bold; color: #333; }
    .table-responsive-cards tbody td[data-label="Acciones"] { text-align: center; padding-left: 15px; }
    .table-responsive-cards tbody td[data-label="Acciones"]::before { display: none; }
    
    /* Estilo para la nueva foto en móvil */
    .table-responsive-cards tbody td[data-label="Foto"] img {
        max-width: 40px; /* Hacer la imagen pequeña en la tarjeta */
        border-radius: 50%;
    }
}
</style>

    {% if messages %}
        {% for message in messages %}
             <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'info' %}alert-info{% else %}alert-danger{% endif %} alert-dismissible">
                <button class="close" data-dismiss="alert"><i class="pci-cross pci-circle"></i></button>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="panel">
        <div class="panel-heading">
            <h3 class="panel-title">Personal / Recursos Actuales ({{ current_staff_count }}/{{ max_staff }})</h3>
        </div>
        <div class="panel-body">
            {% if staff_list %}
                <div class="table-responsive table-responsive-cards">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                {# --- CAMBIO 1: Nueva columna "Foto" --- #}
                                <th style="width: 60px;">Foto</th>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for staff in staff_list %}
                            <tr>
                                {# --- CAMBIO 1: Usamos la propiedad get_photo_url --- #}
                                <td data-label="Foto">
                                    <img src="{{ staff.get_photo_url }}" alt="{{ staff.name }}" class="img-circle img-sm">
                                </td>
                                <td data-label="Nombre">{{ staff.name }}</td>
                                <td data-label="Tipo">
                                    {% if staff.user %}
                                        <span class="badge badge-info">Usuario con Acceso</span>
                                    {% else %}
                                        <span class="badge badge-default">Recurso</span>
                                    {% endif %}
                                </td>
                                <td data-label="Estado">
                                    {% if staff.is_active %}
                                        <span class="badge badge-success">Activo</span>
                                    {% else %}
                                        <span class="badge badge-danger">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td data-label="Acciones">
                                    {% if staff.user == request.user %}
                                    <button class="btn btn-xs btn-default" disabled="disabled" title="Para editar tus datos personales, ve a 'Configuración Negocio' o 'Mi Perfil'.">
                                        Editar (Tú)
                                    </button>
                                {% else %}
                                    <a href="{% url 'edit_staff' pk=staff.pk %}" class="btn btn-xs btn-default">
                                        Editar
                                    </a>
                                {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Aún no has añadido personal o recursos.</p>
            {% endif %}
        </div>
    </div>

    {# --- Formulario para Añadir Nuevo --- #}
    {% if can_add_staff %}
        <div class="panel">
            <div class="panel-heading">
                <h3 class="panel-title">Añadir Nuevo Personal o Recurso</h3>
            </div>
            <div class="panel-body">
                {# --- CAMBIO: Añadimos enctype para la subida de fotos --- #}
                <form method="post" enctype="multipart/form-data" id="add-staff-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                         <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                         {{ form.name|add_class:"form-control" }}
                         {% include 'includes/field_errors.html' with field=form.name %}
                    </div>

                    <div class="form-check mb-3">
                        {{ form.give_access|add_class:"form-check-input"|attr:"id:id_give_access" }} 
                        <label class="form-check-label" for="id_give_access">
                            {{ form.give_access.label }}
                        </label>
                         {% include 'includes/field_errors.html' with field=form.give_access %}
                    </div>
                    
                    {# --- CAMBIO 2: Nuevo DIV para el campo 'photo' --- #}
                    <div id="resource-fields" style="display: none;">
                        <div class="mb-3">
                            <label for="{{ form.photo.id_for_label }}" class="form-label">{{ form.photo.label }}</label>
                            {{ form.photo|add_class:"form-control" }}
                            <small class="form-text text-muted">Sube una foto si este recurso es una "Silla" o "Cabina".</small>
                            {% include 'includes/field_errors.html' with field=form.photo %}
                        </div>
                    </div>
                    {# --- Fin Nuevo DIV --- #}

                    {# --- Campos Condicionales (Sin Cambios) --- #}
                    <div id="access-fields" style="display: {% if form.give_access.value %}block{% else %}none{% endif %};">
                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                            {{ form.email|add_class:"form-control" }}
                            <small class="form-text text-muted">Si el usuario ya existe, se vinculará. Si no, se creará una cuenta.</small>
                            {% include 'includes/field_errors.html' with field=form.email %}
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">{{ form.first_name.label }}</label>
                                {{ form.first_name|add_class:"form-control" }}
                                {% include 'includes/field_errors.html' with field=form.first_name %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">{{ form.last_name.label }}</label>
                                {{ form.last_name|add_class:"form-control" }}
                                {% include 'includes/field_errors.html' with field=form.last_name %}
                            </div>
                        </div>
                         <div class="mb-3">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">{{ form.phone_number.label }}</label>
                            {{ form.phone_number|add_class:"form-control" }}
                            {% include 'includes/field_errors.html' with field=form.phone_number %}
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Añadir</button>
                </form>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning">
            {{ limit_message }} <a href="#">Actualiza tu plan</a> para añadir más personal.
        </div>
    {% endif %}

{% endblock %}

{% block page_script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const giveAccessCheckbox = document.getElementById('id_give_access');
    const accessFieldsDiv = document.getElementById('access-fields');
    const accessInputs = accessFieldsDiv ? accessFieldsDiv.querySelectorAll('input') : []; 
    
    {# --- CAMBIO 3: Nueva referencia al campo de foto --- #}
    const resourceFieldsDiv = document.getElementById('resource-fields');

    function toggleAccessFields() {
        if (!giveAccessCheckbox || !accessFieldsDiv || !resourceFieldsDiv) return;
        
        const isChecked = giveAccessCheckbox.checked;
        
        // Mostrar campos de Acceso (email, nombre) SI está marcado
        accessFieldsDiv.style.display = isChecked ? 'block' : 'none';
        
        // --- CAMBIO 3: Mostrar campo de Foto SI NO está marcado (es un recurso) ---
        resourceFieldsDiv.style.display = isChecked ? 'none' : 'block';
        
        // Lógica de campos requeridos (sin cambios)
        accessInputs.forEach(input => {
            if (input.name !== 'phone_number'){
                 input.required = isChecked;
            } else {
                 input.required = false; 
            }
        });
    }

    if(giveAccessCheckbox){
        toggleAccessFields(); // Ejecutar al cargar
        giveAccessCheckbox.addEventListener('change', toggleAccessFields); // Ejecutar al cambiar
    }
});
</script>
{% endblock %}