{% extends 'dashboard/dashboard_base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Configuración del Negocio - Tivy{% endblock %}
{% block page_title %}Configuración del Negocio{% endblock %}

{% block breadcrumb %}
    <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="active">Configuración Negocio</li>
{% endblock %}

{% block page_head %}
    {# --- CSS para Tagify vía CDN --- #}
    <link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

    {# --- NUEVO: JS para generar QR (Añadido) --- #}
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
{% endblock %}

{% block content %}

    {% if messages %}
        {% for message in messages %}
             <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible">
                <button class="close" data-dismiss="alert"><i class="pci-cross pci-circle"></i></button>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8 col-lg-offset-2"> 
            <div class="panel">
                <div class="panel-heading">
                    <h3 class="panel-title">Edita la Información de tu Negocio</h3>
                </div>
                <div class="panel-body">

                    {# --- INICIO: NUEVO BLOQUE DE ENLACE PÚBLICO Y QR (CORREGIDO) --- #}
                    <div class="panel" style="background-color: #f9f9f9; border: 1px solid #eee;">
                        <div class="panel-heading">
                            <h3 class="panel-title">Tu Página de Citas</h3>
                        </div>
                        <div class="panel-body">
                            <p>Este es el enlace único que puedes compartir con tus clientes para que agenden citas:</p>
                            
                            {% comment %}
                                1. Usamos el nombre 'business_profile' de tu urls.py
                                2. 'object' es la variable estándar de UpdateView para el negocio
                            {% endcomment %}
                            {% url 'business_profile' slug=object.slug as booking_url %}

                            {% comment %}
                                3. CORRECCIÓN: Construimos la URL directamente aquí.
                                   Ya no usamos la etiqueta falsa 'capturefull'.
                            {% endcomment %}
                            <div class="input-group mar-btm">
                                <input type="text" id="public-booking-url" class="form-control" 
                                       value="{{ request.scheme }}://{{ request.get_host }}{{ booking_url }}" readonly>
                                <span class="input-group-btn">
                                    <button class="btn btn-primary" type="button" id="copy-url-btn">Copiar</button>
                                </span>
                            </div>

                            <p class="text-center mar-top">O comparte tu código QR:</p>
                            
                            {% comment %}
                                4. CORRECCIÓN: Pasamos la URL construida directamente
                                   al atributo 'data-url'.
                            {% endcomment %}
                            <div id="booking-qr-code" 
                                 data-url="{{ request.scheme }}://{{ request.get_host }}{{ booking_url }}" 
                                 style="width: 150px; height: 150px; margin: 10px auto; border: 5px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                 </div>
                        </div>
                    </div>
                    <hr>
                    {# --- FIN: NUEVO BLOQUE DE ENLACE PÚBLICO Y QR --- #}


                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        {# --- Campos del Formulario (SIN CAMBIOS) --- #}
                        <div class="mb-3">
                             <label for="{{ form.display_name.id_for_label }}" class="form-label">{{ form.display_name.label }}</label>
                             {{ form.display_name|add_class:"form-control" }}
                             {% include 'includes/field_errors.html' with field=form.display_name %}
                        </div>

                        <div class="mb-3">
                             <label for="{{ form.photo.id_for_label }}" class="form-label">{{ form.photo.label }} (Logo)</label>
                             {% if object.photo %} {# Usamos 'object' de UpdateView #}
                             <p><img src="{{ object.photo.url }}" alt="Logo actual" style="max-height: 80px; margin-bottom: 10px;"></p>
                             {% endif %}
                             {{ form.photo|add_class:"form-control" }}
                             {% include 'includes/field_errors.html' with field=form.photo %}
                        </div>

                        <div class="mb-3">
                             <label for="{{ form.bio.id_for_label }}" class="form-label">{{ form.bio.label }}</label>
                             {{ form.bio|add_class:"form-control" }}
                             {% include 'includes/field_errors.html' with field=form.bio %}
                        </div>
                        
                        <hr>
                        <h4>Ubicación y Atención</h4>

                        <div class="mb-3">
                             <label for="{{ form.location_name.id_for_label }}" class="form-label">{{ form.location_name.label }}</label>
                             {{ form.location_name|add_class:"form-control" }}
                             {% include 'includes/field_errors.html' with field=form.location_name %}
                        </div>

                        <div class="mb-3">
                             <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
                             {{ form.address|add_class:"form-control" }}
                             {% include 'includes/field_errors.html' with field=form.address %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }}</label>
                                {{ form.city|add_class:"form-control" }}
                                {% include 'includes/field_errors.html' with field=form.city %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.country.id_for_label }}" class="form-label">{{ form.country.label }}</label>
                                {{ form.country|add_class:"form-control" }}
                                {% include 'includes/field_errors.html' with field=form.country %}
                            </div>
                        </div>

                        <div class="mb-3">
                             <label for="{{ form.service_delivery_type.id_for_label }}" class="form-label">{{ form.service_delivery_type.label }}</label>
                             {{ form.service_delivery_type|add_class:"form-control" }}
                             {% include 'includes/field_errors.html' with field=form.service_delivery_type %}
                        </div>

                        <div id="domicilio-fields" style="display: {% if object.service_delivery_type == 'LOCAL' %}none{% else %}block{% endif %};">
                            <div class="mb-3">
                                <label for="{{ form.travel_buffer.id_for_label }}" class="form-label">{{ form.travel_buffer.label }}</label>
                                {{ form.travel_buffer|add_class:"form-control" }}
                                <small class="form-text text-muted">Formato: HH:MM:SS (Ej: 00:30:00 para 30 minutos).</small>
                                {% include 'includes/field_errors.html' with field=form.travel_buffer %}
                            </div>

                             <div class="mb-3">
                                <label for="{{ form.service_zones_text.id_for_label }}" class="form-label">{{ form.service_zones_text.label }}</label>
                                {{ form.service_zones_text }} 
                                <small class="form-text text-muted">{{ form.service_zones_text.help_text }}</small>
                                {% include 'includes/field_errors.html' with field=form.service_zones_text %}
                             </div>
                        </div>

                        <hr>
                        <h4>Personalización Visual</h4>

                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.primary_color.id_for_label }}" class="form-label">{{ form.primary_color.label }}</label>
                                {{ form.primary_color|add_class:"form-control form-control-color" }}
                                {% include 'includes/field_errors.html' with field=form.primary_color %}
                            </div>
                             <div class="col-md-6 mb-3">
                                <label for="{{ form.secondary_color.id_for_label }}" class="form-label">{{ form.secondary_color.label }}</label>
                                {{ form.secondary_color|add_class:"form-control form-control-color" }}
                                {% include 'includes/field_errors.html' with field=form.secondary_color %}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">Guardar Configuración</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}


{% block page_script %}
    {# --- JS para Tagify vía CDN --- #}
    <script src="https://unpkg.com/@yaireo/tagify"></script>
    <script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Inicializar Tagify (CORREGIDO) ---
            // Apuntamos al ID que Django genera para 'service_zones_text'
            var input = document.getElementById('{{ form.service_zones_text.id_for_label }}'); 
            if (input) {
                new Tagify(input, {
                    delimiters: ",", 
                });
            }

            // --- JS para campos condicionales (SIN CAMBIOS) ---
            const deliveryTypeSelect = document.getElementById('{{ form.service_delivery_type.id_for_label }}');
            const domicilioFieldsDiv = document.getElementById('domicilio-fields');

            function toggleDomicilioFields() {
                if (!deliveryTypeSelect || !domicilioFieldsDiv) return;
                if (deliveryTypeSelect.value === 'LOCAL') {
                    domicilioFieldsDiv.style.display = 'none';
                } else {
                    domicilioFieldsDiv.style.display = 'block';
                }
            }
            if (deliveryTypeSelect) {
                 toggleDomicilioFields(); 
                 deliveryTypeSelect.addEventListener('change', toggleDomicilioFields);
            }

            // --- INICIO: NUEVA LÓGICA PARA QR Y BOTÓN "COPIAR" ---
            
            // 1. Generar el Código QR
            const qrCodeEl = document.getElementById('booking-qr-code');
            
            if (qrCodeEl && typeof QRCode !== 'undefined') {
                const bookingUrl = qrCodeEl.getAttribute('data-url');
                if (bookingUrl) {
                    new QRCode(qrCodeEl, {
                        text: bookingUrl,
                        width: 150,
                        height: 150,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
            }

            // 2. Lógica del botón "Copiar"
            const copyBtn = document.getElementById('copy-url-btn');
            const urlInput = document.getElementById('public-booking-url');
            
            if (copyBtn && urlInput) {
                copyBtn.addEventListener('click', function() {
                    urlInput.select();
                    try {
                        // Intentamos usar la API moderna de Portapapeles
                        navigator.clipboard.writeText(urlInput.value).then(function() {
                            copyBtn.innerText = '¡Copiado!';
                            setTimeout(function() { copyBtn.innerText = 'Copiar'; }, 2000);
                        }, function(err) {
                            // Fallback para navegadores (incluyendo http)
                            document.execCommand('copy');
                            copyBtn.innerText = '¡Copiado!';
                            setTimeout(function() { copyBtn.innerText = 'Copiar'; }, 2000);
                        });
                    } catch (err) {
                        alert('No se pudo copiar el enlace. Cópialo manualmente.');
                    }
                    window.getSelection().removeAllRanges();
                });
            }
            // --- FIN: NUEVA LÓGICA ---

        });
    </script>
{% endblock %}