{% extends 'base.html' %}

{% block title %}Paso 3: Confirma tu Cita{% endblock %}

{% block content %}
<div class="container">
    <h1>Paso 3: Confirma los Detalles</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            Resumen de tu Cita
        </div>
        <div class="card-body">
            <p><strong>Profesional:</strong> {{ client.display_name }}</p>
            <p><strong>Servicio:</strong> {{ service.name }}</p>
            <p><strong>Fecha y Hora:</strong> {{ selected_datetime|date:"l, d \d\e F" }} a las {{ selected_datetime|time:"H:i" }}</p>
        </div>
    </div>
    
    <h4>Completa tus datos para finalizar</h4>
    <form method="post">
        {% csrf_token %}
        
        {# --- SECCIÓN DE EMAIL (SIEMPRE VISIBLE) --- #}
        <div class="mb-3">
            <label for="id_email" class="form-label">Email</label>
            <input type="email" name="email" class="form-control" id="id_email" required>
            <div id="email-loader" class="form-text" style="display: none;">Verificando...</div>
        </div>
        
        {# --- CONTENEDOR DE DATOS ADICIONALES (INICIALMENTE OCULTO) --- #}
        <div id="customer-details-container" style="display: none;">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="id_first_name" class="form-label">Nombre</label>
                    <input type="text" name="first_name" class="form-control" id="id_first_name" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="id_last_name" class="form-label">Apellido</label>
                    <input type="text" name="last_name" class="form-control" id="id_last_name" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="id_phone_number" class="form-label">Teléfono (Opcional)</label>
                <input type="text" name="phone_number" class="form-control" id="id_phone_number">
            </div>
        </div>

        {# --- LÓGICA DE UBICACIÓN (SE MANTIENE IGUAL EN EL HTML) --- #}
        {% if service.location_type == 'DOMICILIO' %}
            <div class="mb-3">
                <label for="id_address" class="form-label">Dirección para el servicio a domicilio</label>
                <input type="text" name="address" class="form-control" id="id_address" required>
            </div>
        {% elif service.location_type == 'AMBOS' %}
            <div class="mb-3">
                <p><strong>¿Dónde deseas recibir el servicio?</strong></p>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="location_choice" id="choice_local" value="local" checked>
                    <label class="form-check-label" for="choice_local">
                        En el local: {{ client.address }}
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="location_choice" id="choice_domicilio" value="domicilio">
                    <label class="form-check-label" for="choice_domicilio">
                        A domicilio
                    </label>
                </div>
                <div id="address-field-container" class="mt-2" style="display:none;">
                    <label for="id_address" class="form-label">Tu dirección</label>
                    <input type="text" name="address" class="form-control" id="id_address_ambos"> {# ID único para evitar conflictos #}
                </div>
            </div>
        {% endif %}

        <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Confirmar y Agendar Cita</button>
        </div>
    </form>
</div>

{# --- SCRIPT UNIFICADO (FUERA DE CUALQUIER IF DE DJANGO) --- #}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- LÓGICA DE VERIFICACIÓN DE EMAIL ---
        const emailInput = document.getElementById('id_email');
        const detailsContainer = document.getElementById('customer-details-container');
        const firstNameInput = document.getElementById('id_first_name');
        const lastNameInput = document.getElementById('id_last_name');
        const phoneInput = document.getElementById('id_phone_number');
        const emailLoader = document.getElementById('email-loader');

        emailInput.addEventListener('blur', async () => {
            const email = emailInput.value.trim();
            if (email.length < 5 || !email.includes('@')) {
                detailsContainer.style.display = 'block'; // Mostrar si el email es borrado o inválido
                return;
            }

            emailLoader.style.display = 'block';

            try {
                const response = await fetch(`/api/check-customer/?email=${encodeURIComponent(email)}`);
                const data = await response.json();

                if (data.exists) {
                    firstNameInput.value = data.first_name;
                    lastNameInput.value = data.last_name;
                    phoneInput.value = data.phone_number || '';
                    firstNameInput.readOnly = true;
                    lastNameInput.readOnly = true;
                } else {
                    firstNameInput.value = '';
                    lastNameInput.value = '';
                    phoneInput.value = '';
                    firstNameInput.readOnly = false;
                    lastNameInput.readOnly = false;
                }
                
                detailsContainer.style.display = 'block';

            } catch (error) {
                console.error('Error al verificar el cliente:', error);
                detailsContainer.style.display = 'block'; // Mostrar los campos para llenado manual si hay error
            } finally {
                emailLoader.style.display = 'none';
            }
        });

        // --- LÓGICA CONDICIONAL PARA EL SELECTOR DE UBICACIÓN ---
        const radioDomicilio = document.getElementById('choice_domicilio');
        // Si el elemento 'choice_domicilio' existe, entonces el servicio es de tipo 'AMBOS'
        if (radioDomicilio) {
            const radioLocal = document.getElementById('choice_local');
            const addressContainer = document.getElementById('address-field-container');
            const addressInput = document.getElementById('id_address_ambos');

            const toggleAddressField = () => {
                if (radioDomicilio.checked) {
                    addressContainer.style.display = 'block';
                    addressInput.required = true;
                } else {
                    addressContainer.style.display = 'none';
                    addressInput.required = false;
                }
            };
            radioDomicilio.addEventListener('change', toggleAddressField);
            radioLocal.addEventListener('change', toggleAddressField);
        }
    });
</script>
{% endblock %}